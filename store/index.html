<!DOCTYPE html>
<html>

<head>
    <title>Hein Album Board</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <script type="text/javascript" src="js/pako.min.js"></script>
    <script type="text/javascript" src="js/jquery-2.0.3.min.js"></script>
    <script>
        const databasePrefix = prompt("Enter your prefix: ", "");
        const kakaoPrefix = prompt("Enter your kakao prefix: ", "");
        const databaseUrl = `https://${databasePrefix}-database.fly.dev/netlify-store`;
    </script>
    <script text="text/javascript" src="js/indexeddb.js"></script>
    <script text="text/javascript" src="js/couchdb.js"></script>
    <script text="text/javascript" src="js/image.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script>
        // 페이지 로딩전 검사
        (function () {
            const credentials = btoa(`${databasePrefix}:${databasePrefix}`);
            fetch(`${databaseUrl}`, {
                method: "GET",
                headers: {
                    'Authorization': `Basic ${credentials}`,
                    'Content-Type': 'application/json'
                }
            }).then(data => {
                console.log(data);
            }).catch(error => {
                console.log(error);
                //alert('인증 실패');
                window.history.back();
            });
        })();

        function viewImage(btn) {
            // 클릭된 버튼의 tr 요소 가져오기
            var tr = btn.closest('tr');
            // 해당 tr에서 4번째 <td> 요소 가져오기 (인덱스 3)
            var fourthTd = tr.getElementsByTagName('td')[3];
            // 4번째 <td>의 텍스트 가져오기
            var text = fourthTd.textContent;

            btn.setAttribute('data-expanded', 'true');
            const imageRow = document.createElement('tr');
            imageRow.className = 'image-row';
            const imageCell = document.createElement('td');
            imageCell.colSpan = 5; // 테이블의 컬럼 수에 따라 조정
            const img = document.createElement('img');

            (async () => {
                const q = {
                    "selector": {
                        "primary": {
                            "$eq": text
                        }
                    },
                    "fields": [
                        "encode"
                    ]
                };

                let response = await selectCouchDB(q);
                console.log(response);

                response['docs'].forEach((element, index) => {
                    img.src = decompressBase64ToString(element['encode']);
                    imageCell.appendChild(img);
                    imageRow.appendChild(imageCell);
                    tr.parentNode.insertBefore(imageRow, tr.nextSibling);
                    imageRow.style.display = 'table-row'; // 이미지 행 보이기
                });
            })();
        }
    </script>

</head>

<body>
    <div id="form">
        <h1>Board manage</h1>
        <form id="mycontact">
            <input id="id" type="hidden" value="" />
            <fieldset>
                <legend>게시판</legend>
                <ol id="list">
                    <li>
                        <div class="tag-container" id="tag-container">
                            <input type="text" id="input_tag" class="tag-input"
                                placeholder="Enter tags separated by commas" />
                        </div>
                    </li>
                    <li>
                        <input id="input_caption" type="text" placeholder="caption..." required>
                    </li>
                </ol>
            </fieldset>

            <div class="btn_set">
                <input type="file" id="image_input" multiple><br>
                <span id="btn_insert" class="btn">이미지 업로드</span>
                <span class="btn" onclick="window.location.href='/gallery/index.html?prefix=liam'">갤러리 이동</span>
            </div>
        </form>
    </div>
    <br />
    <div id="boardlist" class="boardlist">
        <table id="listTable">
            <thead>
                <tr>
                    <th>번호</th>
                    <th>태그</th>
                    <th>캡션</th>
                    <th>키값</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <script type="module" src="js/script.js"></script>
</body>

</html>