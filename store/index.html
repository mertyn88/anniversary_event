<!DOCTYPE html>
<html>

<head>
    <title>Hein Album Board</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="js/pako.min.js"></script>
    <script type="text/javascript" src="js/jquery-2.0.3.min.js"></script>
    <script>
        const databasePrefix = prompt("Enter your prefix:", "");
        const databaseUrl = `https://${databasePrefix}-database.fly.dev/netlify-store`;
    </script>
    <script text="text/javascript" src="js/indexeddb.js"></script>
    <script text="text/javascript" src="js/couchdb.js"></script>
    <script text="text/javascript" src="js/image.js"></script>
    <script>



    </script>
    <style>
        body {
            margin: 0;
            background: #666;
            font-family: Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
    
        #form {
            background: #FFF;
            border-radius: 10px;
            margin: 10px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,.2);
            font-size: 16px;
        }
    
        .boardlist {
            background: #FFF;
            border-radius: 10px;
            margin: 10px;
            padding: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,.2);
            font-size: 16px;
        }
    
        #list, .boardlist ol li, #listTable thead th, #listTable tbody td {
            margin-top: 5px;
            margin-bottom: 5px;
        }

        ol li {
            display: inline;
        }
    
        #listTable {
            width: calc(100% - 20px);
            border-collapse: collapse;
            margin-top: 0;
        }
    
        #listTable thead th {
            padding: 15px;
            background-color: #3498db;
            color: #ffffff;
            font-size: 18px;
            border-bottom: 2px solid #2980b9;
        }
    
        #listTable tbody td {
            padding: 15px;
            background: #FFF;
            border-bottom: 1px solid #ddd;
            font-size: 16px;
        }
    
        #listTable tbody tr:hover {
            background-color: #f2f2f2;
        }
    
        .btn {
            width: auto;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            text-align: center;
            display: inline-block;
            min-width: 80px;
            margin: 5px;
            background-image: -webkit-linear-gradient(top, #3498db, #2980b9);
            background-image: -moz-linear-gradient(top, #3498db, #2980b9);
            background-image: -ms-linear-gradient(top, #3498db, #2980b9);
            background-image: -o-linear-gradient(top, #3498db, #2980b9);
            background-image: linear-gradient(to bottom, #3498db, #2980b9);
            color: #ffffff;            
        }

    
        #listTable button {
            width: auto;
            margin: 0;
            padding: 8px 16px;
            font-size: 16px;
        }
    
        .btn_set {
            margin-top: 20px;
            text-align: center;
        }
    
        input[type=text],
        input[type=file] {
            width: calc(100% - 22px);
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 5px;
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 16px;
        }
    
        @media (max-width: 600px) {
            #form, .boardlist {
                border-radius: 0; /* Full width on small screens */
            }
    
            #listTable {
                width: 100%;
            }
    
            input[type=text],
            input[type=file] {
                width: calc(100% - 20px); /* Adjust input width for small screens */
            }
        }
    </style>
</head>

<body>
    <div id="form">
        <h1>Board manage</h1>
        <form id="mycontact">
            <input id="id" type="hidden" value="" />
            <fieldset>
                <legend>게시판</legend>
                <ol id="list">
                    <li>
                        <label for="tag">태그: </label>
                        <input id="input_tag" type="text" placeholder="tag..." required autofocus>
                    </li>
                    <li>
                        <label for="caption">내용: </label>
                        <input id="input_caption" type="text" placeholder="caption..." required>
                    </li>
                </ol>
            </fieldset>

            <div class="btn_set">
                <input type="file" id="image_input" multiple><br>
                <span id="btn_insert" class="btn">이미지 업로드</span>
            </div>
        </form>
    </div>
    <br />
    <div id="boardlist" class="boardlist">
        <table id="listTable">
            <thead>
                <tr>
                    <th>번호</th>
                    <th>태그</th>
                    <th>캡션</th>
                    <th>키값</th>
                    <th>작업</th>
                </tr>
            </thead>
            <tbody>
                <!--
                <tr>
                    <td>1</td>
                    <td>태그 예시</td>
                    <td>내용 예시</td>
                    <td>
                        <button class="btn_edit">수정</button>
                        <button class="btn_delete">삭제</button>
                    </td>
                </tr>
                -->
            </tbody>
        </table>
    </div>

    <script>
        const manageQuery = query;

        $(document).ready(function () {
            // 현재 리스트 출력
            // encode 제외
            manageQuery['select']['fields'] = manageQuery['select']['fields'].filter(field => field !== 'encode');
            (async () => {
                let response = await selectCouchDB(manageQuery['select']);

                response['docs'].forEach((element, index) => {
                    var $row = $('<tr>').append(
                        $('<td>').text(index),
                        $('<td>').text(element['tag']),
                        $('<td>').text(element['caption']),
                        $('<td>').text(element['primary']),
                        $('<td>').append(
                            //$('<button>').addClass('btn_edit').text('수정'),
                            $('<button>').addClass('btn').text('삭제')
                        )
                    );

                    console.log(index);
                    console.log(element);

                    $('#listTable tbody').append($row);
                });

                console.log(response);
            })();



            // 입력
            $("#btn_insert").click(function () {
                const fileInput = document.getElementById('image_input');
                const files = fileInput.files;

                if (files.length === 0) {
                    alert('Please select at least one file.');
                    return;
                }

                encodeImagesToBase64(files).then(encodedImages => {
                    let compressedBase64 = compressStringToBase64(encodedImages);
                    (async () => {
                        let response = await existCouchDB();
                        let docIndex = 1;

                        // 인덱스 숫자 부여
                        if (response['docs'].length > 0) {
                            docIndex = Number(response['docs'][0]['number']) + 1;
                        }

                        query['insert']['tag'] = $('#input_tag').val();
                        query['insert']['caption'] = $('#input_caption').val();
                        query['insert']['primary'] = `${today}_${docIndex}`
                        query['insert']['number'] = docIndex;
                        query['insert']['encode'] = compressedBase64;
                        response = await insertCouchDB();
                        console.log(response);
                        alert('업로드 완료');
                    })();
                });


                insertDB(systemDB);
            });

            // 리스트 수정버튼
            $("body").on("click", ".btn_edit", function () {
                var no = $(this).data("no");
                var idx = $(this).data("idx");
                $("#id").val(idx);
                loadRecord(no);
            });

            // 업데이트
            $("#btn_update").click(function () {
                updateDB(systemDB);
            });

            // 삭제
            $("body").on("click", ".btn_delete", function () {
                var idx = $(this).data("idx");
                deleteDB(systemDB, idx);
                selectAllList(systemDB, idx);
            });

            // 테이블 삭제
            $("#btn_drop").click(function () {
                dropTable(systemDB);
            });

            // 글 지우기
            $("#btn_reset").click(resetForm);
        });


    </script>
</body>

</html>