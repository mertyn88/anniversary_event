<!DOCTYPE html>
<html>

<head>
    <title>SQL.js and IndexedDB Example</title>
    <script src="sql.js"></script>
    <script src="../js/jquery-2.0.3.min.js"></script>
</head>

<body>
    <button id="save-btn">Save Database</button>
    <button id="load-btn">Load Database</button>
    <button id="query-btn">Run Query</button>
    <div id="result"></div>

    <script>
        let db;

        initSqlJs().then(function (SQL) {
            // 초기 로드 시 IndexedDB에서 데이터베이스를 불러오기
            console.log(SQL);
            loadDatabaseFromIndexedDB(SQL, function (loadedDb) {
                console.log('이곳을 안옴');
                if (loadedDb) {
                    console.log('이곳이 아닌가?');
                    db = loadedDb;
                } else {
                    console.log('여기');
                    // 기존 데이터베이스가 없을 경우 새로 생성
                    db = new SQL.Database();
                    db.run("CREATE TABLE test (col1, col2);");
                    db.run("INSERT INTO test VALUES (?, ?), (?, ?);", [1, 111, 2, 222]);
                }
            });

            //db = new SQL.Database();
            //db.run("CREATE TABLE test (col1, col2);");
            //db.run("INSERT INTO test VALUES (?, ?), (?, ?);", [1, 111, 2, 222]);

            document.getElementById("query-btn").onclick = function () {
                const res = db.exec("SELECT * FROM test;");
                console.log(res);

                // 루프를 사용하여 객체의 내용을 출력
                let text = new Array();

                let idx = 0;
                res.forEach(item => {
                    for (let i = 0; i < item.columns.length; i++) {
                        console.log(item.columns[i] + " " + item.values[i]);
                        text.push(item.columns[i] + " " + item.values[i]);
                    }
                });

                $('#result').html(text.join('<br>'));
            };

            document.getElementById("save-btn").onclick = function () {
                saveDatabaseToIndexedDB(db);
            };

            document.getElementById("load-btn").onclick = function () {
                loadDatabaseFromIndexedDB(SQL, function (loadedDb) {
                    if (loadedDb) {
                        db = loadedDb;
                    }
                });
            };
        });

        // IndexedDB에 데이터 저장 함수
        function saveDatabaseToIndexedDB(db) {
            const data = db.export(); // 데이터베이스를 Uint8Array로 추출
            console.log(data);

            const request = indexedDB.open("myDatabase", 2);

            request.onupgradeneeded = function (event) {
                const db = event.target.result;
                db.createObjectStore("sqliteDB", { keyPath: "id" });
                console.log('zz');
                console.log(db);
            };

            request.onsuccess = function (event) {
                const db = event.target.result;

                console.log('se');
                console.log(db);

                const transaction = db.transaction(["sqliteDB"], "readwrite");
                const store = transaction.objectStore("sqliteDB");

                // 데이터베이스를 저장할 객체 생성
                const sqliteData = {
                    id: 1,
                    data: data
                };

                // IndexedDB에 저장
                store.put(sqliteData);
                console.log("Database saved to IndexedDB.");
            };

            request.onerror = function (event) {
                console.error("Error opening IndexedDB:", event.target.errorCode);
            };
        }


        // IndexedDB에서 데이터 불러오기 함수
        function loadDatabaseFromIndexedDB(SQL, callback) {
            const request = indexedDB.open("myDatabase", 2);

            request.onupgradeneeded = function (event) {
                console.log('hhhhh');
                const db = event.target.result;
                db.createObjectStore("sqliteDB", { keyPath: "id" });
                console.log('zz');
                console.log(db);
            };

            request.onsuccess = function (event) {
                const db = event.target.result;
                

                

                const transaction = db.transaction(["sqliteDB"], "readonly");
                const store = transaction.objectStore("sqliteDB");

                console.log(store);

                const getRequest = store.get(1);
                getRequest.onsuccess = function (event) {
                    if (getRequest.result) {
                        const uint8Array = getRequest.result.data;

                        console.log(SQL);

                        const db = new SQL.Database(uint8Array);
                        console.log("Database loaded from IndexedDB.");
                        callback(db);
                    } else {
                        console.log("No database found in IndexedDB.");
                        callback(undefined);
                    }
                };

                getRequest.onerror = function (event) {
                    console.error("Error loading database from IndexedDB:", event.target.errorCode);
                };





            };

            request.onerror = function (event) {
                console.error("Error opening IndexedDB:", event.target.errorCode);
            };
        }
    </script>
</body>

</html>